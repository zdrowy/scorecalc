{% extends 'base.html' %}
{% load l10n %}

{% block title %}{{ patient.full_name|default:patient.pesel }} - System SCORE2{% endblock %}

{% block extra_head %}
<style>
    .risk-low_to_moderate { 
        background-color: #d1fae5; 
        color: #065f46; 
        border-color: #10b981; 
    }
    .risk-high { 
        background-color: #fed7aa; 
        color: #9a3412; 
        border-color: #f97316; 
    }
    .risk-very_high { 
        background-color: #fecaca; 
        color: #991b1b; 
        border-color: #ef4444; 
    }
    .risk-not_applicable { 
        background-color: #f3f4f6; 
        color: #374151; 
        border-color: #9ca3af; 
    }
    .trend-up { color: #dc2626; }
    .trend-down { color: #16a34a; }
    .trend-stable { color: #6b7280; }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        display: none;
    }
    .success-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        z-index: 10000;
        text-align: center;
        display: none;
    }
</style>
{% endblock %}

{% block header %}
<div class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="py-6">
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-4">
                            <li>
                                <div>
                                    <a href="{% url 'patients:patient_list' %}" class="text-gray-400 hover:text-gray-500">
                                        <svg class="flex-shrink-0 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                                        </svg>
                                    </a>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <svg class="flex-shrink-0 h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="ml-4 text-sm font-medium text-gray-500">{{ patient.full_name|default:patient.pesel }}</span>
                                </div>
                            </li>
                        </ol>
                    </nav>
                    <h1 class="mt-2 text-2xl font-bold leading-7 text-gray-900 sm:text-3xl">
                        <svg class="w-8 h-8 inline-block mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        {{ patient.full_name|default:"Brak nazwiska" }}
                    </h1>
                    <p class="mt-1 text-sm text-gray-500">
                        PESEL: {{ patient.pesel }} • {{ patient.age }} lat • {% if patient.gender == 'M' %}Mężczyzna{% else %}Kobieta{% endif %}
                    </p>
                </div>
                <div class="mt-4 flex md:mt-0 md:ml-4">
                    {% if latest_visit and possible_scores %}
                        <button type="button" onclick="calculateScoreForAll({{ patient.pk }})" 
                                class="btn-success mr-3" id="calculate-all-btn">
                            <svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16a2 2 0 002 2z"></path>
                            </svg>
                            Oblicz SCORE2 dla wszystkich
                        </button>
                    {% endif %}
                    <a href="{% url 'patients:patient_list' %}" class="btn-secondary">
                        <svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Powrót do listy
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Patient Info -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div class="card">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Podstawowe informacje</h3>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">PESEL</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ patient.pesel }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Imię i nazwisko</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ patient.full_name|default:"Brak danych" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Płeć</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if patient.gender == 'M' %}Mężczyzna{% else %}Kobieta{% endif %}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Wiek</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ patient.age }} lat</dd>
                        </div>
                    </div>
                    
                    <!-- Smoking Status -->
<div class="mt-6 border-t border-gray-200 pt-4">
    <h4 class="text-sm font-medium text-gray-700 mb-3">Status palenia</h4>
    
    <!-- Current Status Display -->
    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <span class="text-sm font-medium text-gray-900">Obecny status:</span>
                <span class="ml-2 text-sm">
                    {% if smoking_status == 'smoker' %}
                        <span class="text-red-600">Palący</span>
                    {% elif smoking_status == 'non_smoker' %}
                        <span class="text-green-600">Niepalący</span>
                    {% elif smoking_status == 'assumed_non_smoker' %}
                        <span class="text-yellow-600">Zakładany niepalący (brak danych)</span>
                 
                    {% endif %}
                </span>
            </div>
            <div class="text-xs text-gray-500">
                {% if 'Z' in smoking_info or 'F' in smoking_info %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Z diagnozy ({{ smoking_info }})
                    </span>
                {% elif smoking_info == 'patient_setting' %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/>
                        </svg>
                        Ustawienie użytkownika
                    </span>
                {% else %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-gray-800">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 9a2 2 0 114 0 2 2 0 01-4 0z"/>
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a4 4 0 00-3.446 6.032l-2.261 2.26a1 1 0 101.414 1.415l2.261-2.261A4 4 0 1011 5z" clip-rule="evenodd"/>
                        </svg>
                        {{ smoking_info }}
                    </span>
                {% endif %}
            </div>
        </div>
    </div>

    {% if 'Z' in smoking_info or 'F' in smoking_info %}
        <!-- If status comes from diagnosis, show info that it cannot be changed -->
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex">
                <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Status palenia określony diagnozą</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <p>Status palenia jest automatycznie określany na podstawie kodów ICD-10 w diagnozach pacjenta:</p>
                        <ul class="list-disc list-inside mt-1">
                            <li><strong>F17.2</strong> - Palący (zaburzenia psychiczne i behawioralne z powodu nikotyny)</li>
                            <li><strong>Z87.7</strong> - Niepalący (wywiad osobniczy dotyczący palenia tytoniu)</li>
                            <li><strong>Z58.7</strong> - Niepalący (narażenie na dym tytoniowy)</li>
                        </ul>
                        <p class="mt-2">Aby zmienić status, usuń odpowiedni kod diagnozy lub dodaj właściwy kod ICD-10.</p>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- If status can be changed, show form -->
        <form method="post" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Zmień status palenia</label>
                <select name="smoking_status" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="non_smoker" {% if patient.smoking_status == 'non_smoker' %}selected{% endif %}>Niepalący</option>
                    <option value="smoker" {% if patient.smoking_status == 'smoker' %}selected{% endif %}>Palący</option>
                   
                    <option value="assumed_non_smoker" {% if patient.smoking_status == 'assumed_non_smoker' %}selected{% endif %}>Zakładany niepalący (brak danych)</option>
                </select>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="text-xs text-gray-500">
                    <p>Ta zmiana nadpisze obecne ustawienie użytkownika.</p>
                    <p>Jeśli pacjent ma diagnozy związane z paleniem, one będą miały pierwszeństwo.</p>
                </div>
                <button type="submit" name="update_smoking" class="btn-primary">
                    <svg class="w-4 h-4 mr-1 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Aktualizuj
                </button>
            </div>
        </form>
    {% endif %}
</div>
                </div>
            </div>

            <div class="px-6 py-4 border-b border-gray-200">
{% with current_age=patient.age %}
    <h3 class="mt-4 text-lg font-semibold">Kwalifikacja i progi SCORE2</h3>

    {% if current_age >= 40 and current_age < 70 and has_diabetes %}
      <!-- SCORE2-Diabetes -->
      <h4 class="mt-3 text-blue-600 font-semibold">SCORE2‑Diabetes</h4>
      <div class="grid grid-cols-2 gap-6 mt-2">
        <!-- Badania -->
        <div>
          <p class="font-medium mb-1">Wymagane badania:</p>
          <ul class="list-disc list-inside">
            <li>Ciśnienie skurczowe (SBP)</li>
            <li>Cholesterol całkowity (TC)</li>
            <li>Cholesterol HDL</li>
            <li>HbA1c</li>
            <li>eGFR</li>
            <li>Wiek przy rozpoznaniu cukrzycy</li>
            <li>Status palenia</li>
          </ul>
        </div>
        <!-- Progi ryzyka -->
        <div>
          <p class="font-medium mb-1">Progi ryzyka (10‑letnie):</p>
          <table class="table-auto w-full text-sm border-collapse">
            <thead>
              <tr class="bg-gray-200">
                <th class="border px-2 py-1">Ryzyko</th>
                <th class="border px-2 py-1">Score (%)</th>
              </tr>
            </thead>
            <tbody>
              {% if current_age < 50 %}
                <tr>
                  <td class="border px-2 py-1">Low‑moderate</td>
                  <td class="border px-2 py-1">&lt;2.5%</td>
                </tr>
                <tr>
                  <td class="border px-2 py-1">High</td>
                  <td class="border px-2 py-1">2.5–&lt;7.5%</td>
                </tr>
                <tr>
                  <td class="border px-2 py-1">Very high</td>
                  <td class="border px-2 py-1">≥7.5%</td>
                </tr>
              {% else %}
                <tr>
                  <td class="border px-2 py-1">Low‑moderate</td>
                  <td class="border px-2 py-1">&lt;5%</td>
                </tr>
                <tr>
                  <td class="border px-2 py-1">High</td>
                  <td class="border px-2 py-1">5–&lt;10%</td>
                </tr>
                <tr>
                  <td class="border px-2 py-1">Very high</td>
                  <td class="border px-2 py-1">≥10%</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

    {% elif current_age >= 70 %}
      <!-- SCORE2-OP -->
      <h4 class="mt-3 text-blue-600 font-semibold">SCORE2‑OP</h4>
      <div class="grid grid-cols-2 gap-6 mt-2">
        <div>
          <p class="font-medium mb-1">Wymagane badania:</p>
          <ul class="list-disc list-inside">
            <li>Ciśnienie skurczowe (SBP)</li>
            <li>Cholesterol całkowity (TC)</li>
            <li>Cholesterol HDL</li>
            <li>Status palenia</li>
            <li>Informacja o cukrzycy (tak/nie)</li>
          </ul>
        </div>
        <div>
          <p class="font-medium mb-1">Progi ryzyka (10‑letnie):</p>
          <table class="table-auto w-full text-sm border-collapse">
            <thead>
              <tr class="bg-gray-200">
                <th class="border px-2 py-1">Ryzyko</th>
                <th class="border px-2 py-1">Score (%)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-2 py-1">Low‑moderate</td>
                <td class="border px-2 py-1">&lt;7.5%</td>
              </tr>
              <tr>
                <td class="border px-2 py-1">High</td>
                <td class="border px-2 py-1">7.5–&lt;15%</td>
              </tr>
              <tr>
                <td class="border px-2 py-1">Very high</td>
                <td class="border px-2 py-1">≥15%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    {% elif current_age >= 40 and current_age < 70 %}
      <!-- SCORE2 -->
      <h4 class="mt-3 text-blue-600 font-semibold">SCORE2</h4>
      <div class="grid grid-cols-2 gap-6 mt-2">
        <div>
          <p class="font-medium mb-1">Wymagane badania:</p>
          <ul class="list-disc list-inside">
            <li>Ciśnienie skurczowe (SBP)</li>
            <li>Cholesterol całkowity (TC)</li>
            <li>Cholesterol HDL</li>
            <li>Status palenia</li>
          </ul>
        </div>
        <div>
          <p class="font-medium mb-1">Progi ryzyka (10‑letnie):</p>
          <table class="table-auto w-full text-sm border-collapse">
            <thead>
              <tr class="bg-gray-200">
                <th class="border px-2 py-1">Ryzyko</th>
                <th class="border px-2 py-1">Score (%)</th>
              </tr>
            </thead>
            <tbody>
              {% if current_age < 50 %}
                <tr>
                  <td class="border px-2 py-1">Low‑moderate</td>
                  <td class="border px-2 py-1">&lt;2.5%</td>
                </tr>
                <tr>
                  <td class="border px-2 py-1">High</td>
                  <td class="border px-2 py-1">2.5–&lt;7.5%</td>
                </tr>
                <tr>
                  <td class="border px-2 py-1">Very high</td>
                  <td class="border px-2 py-1">≥7.5%</td>
                </tr>
              {% else %}
                <tr>
                  <td class="border px-2 py-1">Low‑moderate</td>
                  <td class="border px-2 py-1">&lt;5%</td>
                </tr>
                <tr>
                  <td class="border px-2 py-1">High</td>
                  <td class="border px-2 py-1">5–&lt;10%</td>
                </tr>
                <tr>
                  <td class="border px-2 py-1">Very high</td>
                  <td class="border px-2 py-1">≥10%</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

    {% else %}
      <p class="text-red-600 mt-4">Brak kwalifikacji SCORE2 (wiek poza zakresem 40–89 lat)</p>
    {% endif %}

{% endwith %}



            </div>
        </div>

        <!-- SCORE2 Stats -->
        {% if score_stats %}
        <div class="card">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Statystyki SCORE2</h3>
            </div>
            <div class="p-6">
                <!-- Chart for multiple results -->
                {% if score_stats.count > 1 %}
                <div class="mb-6">
                    <canvas id="score-chart" width="400" height="200"></canvas>
                </div>
                {% endif %}
                
                <div class="text-center mb-4">
                    <div class="text-sm text-gray-500">{{ score_stats.count }} obliczeń</div>
                    <div class="text-2xl font-bold text-gray-900">{{ score_stats.average_score|floatformat:1 }}%</div>
                    <div class="text-sm text-gray-500">Średnia</div>
                </div>
                
                
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Visits -->
    <div class="card">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Historia wizyt</h3>
        </div>
        <div class="space-y-4 p-6">
            {% for data in visit_data %}
            <div class="border border-gray-200 rounded-lg p-4" id="visit-{{ data.visit.id }}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-medium text-gray-900">{{ data.visit.visit_date }}</h4>
                        <p class="text-sm text-gray-500">{{ data.visit.quarter }} • Wiek: {{ data.age }} lat</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="toggleEdit({{ data.visit.id }})" class="btn-secondary text-xs">
                            Edytuj
                        </button>
                        {% if not data.score or not data.score.is_calculation_successful %}
                        <form method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="visit_id" value="{{ data.visit.id }}">
                            <button type="submit" name="calculate_visit_score" class="btn-primary text-xs">
                                Oblicz SCORE2
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <!-- Display mode -->
                <div id="display-{{ data.visit.id }}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>Ciśnienie:</span>
                                <span class="{% if not data.visit.systolic_pressure %}text-red-500{% endif %}">
                                    {{ data.visit.systolic_pressure|default:"Brak" }}{% if data.visit.systolic_pressure %} mmHg{% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cholesterol całk.:</span>
                                <div class="text-right">
                                    {% if data.score and data.score.cholesterol_total and not data.visit.cholesterol_total %}
                                        <span class="text-green-600">{{ data.score.cholesterol_total }} mg/dl</span>
                                        <div class="text-xs text-blue-600 italic">{{ data.score.cholesterol_info }}</div>
                                    {% else %}
                                        <span class="{% if not data.visit.cholesterol_total %}text-red-500{% endif %}">
                                            {{ data.visit.cholesterol_total|default:"Brak" }}{% if data.visit.cholesterol_total %} mg/dl{% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <span>Cholesterol HDL:</span>
                                <div class="text-right">
                                    {% if data.score and data.score.cholesterol_hdl and not data.visit.cholesterol_hdl %}
                                        <span class="text-green-600">{{ data.score.cholesterol_hdl }} mg/dl</span>
                                        <div class="text-xs text-blue-600 italic">{{ data.score.cholesterol_info }}</div>
                                    {% else %}
                                        <span class="{% if not data.visit.cholesterol_hdl %}text-red-500{% endif %}">
                                            {{ data.visit.cholesterol_hdl|default:"Brak" }}{% if data.visit.cholesterol_hdl %} mg/dl{% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>HbA1c:</span>
                                <div class="text-right">
                                    {% if data.score and data.score.hba1c and not data.visit.hba1c %}
                                        <span class="text-green-600">{{ data.score.hba1c }} %</span>
                                        <div class="text-xs text-blue-600 italic">dane z poprzedniej wizyty</div>
                                    {% else %}
                                        <span class="{% if not data.visit.hba1c %}text-red-500{% endif %}">
                                            {{ data.visit.hba1c|default:"Brak" }}{% if data.visit.hba1c %} %{% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <span>eGFR:</span>
                                <div class="text-right">
                                    {% if data.score and data.score.egfr and not data.visit.egfr %}
                                        <span class="text-green-600">{{ data.score.egfr }} ml/min/1.73m²</span>
                                        <div class="text-xs text-blue-600 italic">dane z poprzedniej wizyty</div>
                                    {% else %}
                                        <span class="{% if not data.visit.egfr %}text-red-500{% endif %}">
                                            {{ data.visit.egfr|default:"Brak" }}{% if data.visit.egfr %} ml/min/1.73m²{% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SCORE2 Results -->
                    {% if data.score %}
                    <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-sm font-medium text-gray-900">{{ data.score.score_type }}</span>
                                {% if data.score.is_calculation_successful %}
                                    <span class="ml-2 text-lg font-bold text-blue-600">{{ data.score.score_value }}%</span>
                                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium risk-{{ data.score.risk_level }}">
                                        {{ data.score.get_risk_level_display }}
                                    </span>
                                {% else %}
                                    <span class="ml-2 text-sm text-red-600">{{ data.score.missing_data_reason }}</span>
                                {% endif %}
                            </div>
                            <span class="text-xs text-gray-500">{{ data.score.created_at|date:"d.m.Y H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Edit mode -->
                <div id="edit-{{ data.visit.id }}" style="display: none;">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="visit_id" value="{{ data.visit.id }}">
                        
                        <!-- Display form errors if any -->
                        {% if form.errors %}
                            <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                                <div class="text-sm text-red-800">
                                    <strong>Błędy walidacji:</strong>
                                    <ul class="mt-1 list-disc list-inside">
                                        {% for field, errors in form.errors.items %}
                                            {% for error in errors %}
                                                <li>{{ field }}: {{ error }}</li>
                                            {% endfor %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ciśnienie skurczowe (mmHg)</label>
                                <input type="number" name="systolic_pressure" 
                                       value="{{ data.visit.systolic_pressure|default:'' }}" 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                       min="60" max="300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cholesterol całkowity (mg/dl)</label>
                                <input type="number" step="0.01" name="cholesterol_total" 
                                       value="{{ data.visit.cholesterol_total|default:''|unlocalize }}" 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                       min="0" max="1000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cholesterol HDL (mg/dl)</label>
                                <input type="number" step="0.01" name="cholesterol_hdl" 
                                       value="{{ data.visit.cholesterol_hdl|default:''|unlocalize }}" 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                       min="0" max="200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">HbA1c (%)</label>
                                <input type="number" step="0.01" name="hba1c" 
                                       value="{{ data.visit.hba1c|default:''|unlocalize }}" 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                       min="3" max="20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">eGFR (ml/min/1.73m²)</label>
                                <input type="number" step="0.01" name="egfr" 
                                       value="{{ data.visit.egfr|default:''|unlocalize }}" 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                       min="0" max="200">
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button type="submit" name="update_visit_and_calculate" class="btn-primary">
                                Zapisz i oblicz SCORE2
                            </button>
                            <button type="submit" name="update_visit" class="btn-secondary">
                                Tylko zapisz
                            </button>
                            <button type="button" onclick="toggleEdit({{ data.visit.id }})" class="btn-secondary">
                                Anuluj
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
  
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="bg-white p-8 rounded-lg shadow-lg text-center">
        <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-600 font-medium" id="loading-text">Obliczanie SCORE2...</p>
    </div>
</div>

<!-- Success Message -->
<div id="success-message" class="success-message">
    <div class="mb-4">
        <svg class="h-16 w-16 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-900 mb-2">Sukces!</h3>
    <p class="text-gray-600" id="success-text">SCORE2 zostało pomyślnie obliczone dla wszystkich wizyt.</p>
    <button onclick="hideSuccessMessage()" class="mt-4 btn-primary">OK</button>
</div>

<script>
    function calculateScoreForAll(patientId) {
        const btn = document.getElementById('calculate-all-btn');
        const originalText = btn.innerHTML;
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        // Show loading overlay
        loadingOverlay.style.display = 'flex';
        loadingText.textContent = 'Obliczanie SCORE2 dla wszystkich wizyt...';
        
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Obliczanie...';
        
        fetch(`/score2/calculate/${patientId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                showSuccessMessage('SCORE2 zostało pomyślnie obliczone dla wszystkich wizyt!');
                setTimeout(() => {
                    hideSuccessMessage();
                    window.location.reload();
                }, 2000);
            } else {
                showMessage(data.error || 'Wystąpił błąd podczas obliczania SCORE2.', 'error');
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Error:', error);
            showMessage('Wystąpił błąd podczas obliczania SCORE2.', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }

    function toggleEdit(visitId) {
        const displayDiv = document.getElementById(`display-${visitId}`);
        const editDiv = document.getElementById(`edit-${visitId}`);
        
        if (displayDiv.style.display === 'none') {
            displayDiv.style.display = 'block';
            editDiv.style.display = 'none';
        } else {
            displayDiv.style.display = 'none';
            editDiv.style.display = 'block';
            
            // Focus on first input when editing
            const firstInput = editDiv.querySelector('input[type="number"]');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }
    }

    function showSuccessMessage(message) {
        const successMessage = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        successText.textContent = message;
        successMessage.style.display = 'block';
    }

    function hideSuccessMessage() {
        const successMessage = document.getElementById('success-message');
        successMessage.style.display = 'none';
    }

    function showMessage(message, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 max-w-sm w-full bg-white border-l-4 ${type === 'success' ? 'border-green-400' : 'border-red-400'} rounded-md shadow-lg p-4 z-50`;
        
        const iconPath = type === 'success' 
            ? "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
            : "M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z";
            
        messageDiv.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 ${type === 'success' ? 'text-green-400' : 'text-red-400'}" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="${iconPath}" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm">${message}</p>
                </div>
            </div>
        `;

        document.body.appendChild(messageDiv);
        setTimeout(() => {
            messageDiv.style.transition = 'opacity 0.5s';
            messageDiv.style.opacity = '0';
            setTimeout(() => messageDiv.remove(), 500);
        }, 5000);
    }

    // Hide loading overlay on page load
    document.addEventListener('DOMContentLoaded', function() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'none';
        
        // Debug - check if score_stats exists
        {% if score_stats %}
        console.log('Score stats found:', {
            count: {{ score_stats.count }},
            showChart: {{ score_stats.count }} > 1
        });
        {% else %}
        console.log('No score_stats found');
        {% endif %}
        
        // Add loading state for all forms
        const forms = document.querySelectorAll('form[method="post"]');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const loadingOverlay = document.getElementById('loading-overlay');
                const loadingText = document.getElementById('loading-text');
                
                // Check what type of action is being performed
                const submitButton = document.activeElement;
                if (submitButton && submitButton.name === 'update_visit_and_calculate') {
                    loadingText.textContent = 'Zapisywanie i obliczanie SCORE2...';
                } else if (submitButton && submitButton.name === 'update_visit') {
                    loadingText.textContent = 'Zapisywanie wizyty...';
                } else if (submitButton && submitButton.name === 'calculate_visit_score') {
                    loadingText.textContent = 'Obliczanie SCORE2...';
                } else {
                    loadingText.textContent = 'Przetwarzanie...';
                }
                
                loadingOverlay.style.display = 'flex';
            });
        });

        // Create SCORE2 chart if there are multiple results
        {% if score_stats and score_stats.count > 1 %}
        createScore2Chart();
        {% endif %}
    });

    {% if score_stats and score_stats.count > 1 %}
    function createScore2Chart() {
        console.log('Creating SCORE2 chart...');
        
        // Prepare data from visit_data
        const chartData = [];
        const chartLabels = [];
        const chartColors = [];
        
        {% for data in visit_data %}
            {% if data.score and data.score.is_calculation_successful %}
                chartLabels.push('{{ data.visit.visit_date|date:"d.m.Y" }}');
                chartData.push({{ data.score.score_value|unlocalize }});
                
                console.log('Adding data point:', '{{ data.visit.visit_date|date:"d.m.Y" }}', {{ data.score.score_value|unlocalize }});
                
                // Color based on score type
                {% if data.score.score_type == 'SCORE2' %}
                    chartColors.push('#3B82F6'); // Blue
                {% elif data.score.score_type == 'SCORE2-Diabetes' %}
                    chartColors.push('#EF4444'); // Red
                {% elif data.score.score_type == 'SCORE2-OP' %}
                    chartColors.push('#F59E0B'); // Orange
                {% else %}
                    chartColors.push('#6B7280'); // Gray
                {% endif %}
            {% endif %}
        {% endfor %}

        console.log('Chart data prepared:', {
            labels: chartLabels,
            data: chartData,
            colors: chartColors
        });

        // Reverse arrays to show chronological order (oldest first)
        chartLabels.reverse();
        chartData.reverse();
        chartColors.reverse();

        const ctx = document.getElementById('score-chart');
        console.log('Canvas element:', ctx);
        
        if (ctx && chartData.length > 0) {
            console.log('Creating chart with data...');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'SCORE2 (%)',
                        data: chartData,
                        backgroundColor: chartColors,
                        borderColor: chartColors,
                        borderWidth: 1,
                        maxBarThickness: 60
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `SCORE2: ${context.parsed.y.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...chartData) * 1.1,
                            title: {
                                display: true,
                                text: 'SCORE2 (%)'
                            },
                            grid: {
                                color: '#E5E7EB'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data wizyty'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    }
                }
            });
        } else {
            console.log('Cannot create chart - missing canvas or no data');
        }
    }
    {% endif %}
</script>
{% endblock %}